# RDS Secrets Rotation Guide

This guide explains how to manage and rotate RDS database credentials stored in AWS Secrets Manager.

## Overview

Your RDS database credentials are automatically managed by AWS Secrets Manager:
- **Master password** is auto-generated and stored securely
- **KMS encrypted** with dedicated RDS encryption key
- **No plain-text passwords** in Terraform or application code
- **Automatic retrieval** by EC2 instances via IAM roles

**Current Status**: Secrets are created but **rotation is not enabled by default**.

---

## Understanding Secrets Manager

### What Secrets Are Stored

Two secrets are created for each RDS instance:

1. **Application User Secret** (`demo-app-prod-db-secret`)
   - Username: `app_user`
   - Password: Auto-generated
   - Used by: Application (EC2 instances)
   - Permissions: Read/write to application database

2. **Master User Secret** (`rds!db-xxx-master-secret`)
   - Username: `postgres` (master)
   - Password: Auto-generated by AWS
   - Used by: Administrative tasks only
   - Permissions: Full database admin

### How Secrets Are Accessed

EC2 instances retrieve secrets automatically:

```bash
# Application retrieves connection info from environment variable
# DB_SECRET_ARN is injected by user_data script

# Secrets Manager API call (IAM role-based, no credentials needed)
aws secretsmanager get-secret-value \
  --secret-id $DB_SECRET_ARN \
  --region eu-north-1

# Returns JSON with connection details
{
  "username": "app_user",
  "password": "auto-generated-password",
  "engine": "postgres",
  "host": "demo-app-prod.xxx.eu-north-1.rds.amazonaws.com",
  "port": 5432,
  "dbname": "appdb"
}
```

---

## Manual Password Rotation

Manual rotation is the simplest approach and suitable for most use cases.

### When to Rotate Manually

- **Security incident**: Suspected credential compromise
- **Personnel changes**: Team member with access leaving
- **Compliance requirements**: Annual or quarterly rotation policy
- **Preventive maintenance**: Periodic security hygiene

### Rotate Application User Password

```bash
# Step 1: Generate new password
NEW_PASSWORD=$(openssl rand -base64 32)

# Step 2: Update database user
aws rds-data execute-statement \
  --resource-arn "arn:aws:rds:eu-north-1:ACCOUNT:cluster:demo-app-prod" \
  --secret-arn "$(terraform output -raw db_master_secret_arn)" \
  --database "postgres" \
  --sql "ALTER USER app_user WITH PASSWORD '${NEW_PASSWORD}';"

# Step 3: Update Secrets Manager
SECRET_ARN=$(terraform output -raw db_secret_arn)

aws secretsmanager update-secret \
  --secret-id "${SECRET_ARN}" \
  --secret-string "{
    \"username\": \"app_user\",
    \"password\": \"${NEW_PASSWORD}\",
    \"engine\": \"postgres\",
    \"host\": \"$(terraform output -raw db_endpoint | cut -d':' -f1)\",
    \"port\": 5432,
    \"dbname\": \"appdb\"
  }" \
  --region eu-north-1

# Step 4: Restart application instances (rolling restart via ASG)
ASG_NAME=$(terraform output -raw asg_name)

# Trigger instance refresh (zero-downtime rolling restart)
aws autoscaling start-instance-refresh \
  --auto-scaling-group-name "${ASG_NAME}" \
  --preferences MinHealthyPercentage=50 \
  --region eu-north-1

# Instances will gracefully restart and fetch new password
```

### Rotate Master User Password

```bash
# AWS-managed master password rotation
aws rds modify-db-instance \
  --db-instance-identifier demo-app-prod \
  --master-user-password "$(openssl rand -base64 32)" \
  --apply-immediately \
  --region eu-north-1

# Alternatively: Let AWS rotate it automatically
aws rds modify-db-instance \
  --db-instance-identifier demo-app-prod \
  --manage-master-user-password \
  --apply-immediately \
  --region eu-north-1
```

**Note**: Master password rotation does NOT affect application - only administrative access.

---

## Automatic Password Rotation

Automatic rotation uses AWS Lambda to periodically change passwords without manual intervention.

### Architecture

```
┌─────────────────┐
│ Secrets Manager │
│  (Secret)       │
└────────┬────────┘
         │ Triggers every 30 days
         ▼
┌─────────────────┐
│ Lambda Function │
│  (Rotation)     │◄─── Runs in VPC
└────────┬────────┘
         │ 1. Create new password
         │ 2. Update RDS user
         │ 3. Test connection
         │ 4. Update secret
         ▼
┌─────────────────┐
│ RDS Instance    │
└─────────────────┘
```

### Prerequisites

1. **VPC access**: Lambda must run in private subnet with RDS access
2. **IAM permissions**: Lambda needs SecretsManager and RDS permissions
3. **Security groups**: Lambda SG must allow outbound to RDS
4. **Testing**: Verify in dev environment first

### Enable Automatic Rotation

⚠️ **WARNING**: Automatic rotation is complex. Only enable if you understand the implications.

**Option 1: Using AWS Console (Easiest)**

1. Go to **AWS Secrets Manager** → Find your secret (`demo-app-prod-db-secret`)
2. Click **Rotate secret immediately**
3. Choose **Create a new Lambda function**
4. Select template: **SecretsManagerRDSPostgreSQLRotationSingleUser**
5. Configure:
   - **VPC**: Select your application VPC
   - **Subnets**: Select private subnets (where RDS is)
   - **Security Groups**: Select application security group
6. Set rotation schedule: **30 days**
7. Click **Save**

AWS will:
- Create rotation Lambda function
- Configure IAM roles and permissions
- Set up rotation schedule
- Test initial rotation

**Option 2: Using Terraform (Advanced)**

Add to `terraform/modules/rds/main.tf`:

```hcl
# Lambda rotation function (uses AWS Serverless App Repository)
resource "aws_serverlessapplicationrepository_cloudformation_stack" "postgres_rotator" {
  count = var.enable_automatic_rotation ? 1 : 0

  name = "${local.db_identifier}-rotator"

  application_id   = "arn:aws:serverlessrepo:us-east-1:297356227924:applications/SecretsManagerRDSPostgreSQLRotationSingleUser"
  capabilities     = ["CAPABILITY_IAM", "CAPABILITY_RESOURCE_POLICY"]

  parameters = {
    endpoint            = "https://secretsmanager.${var.aws_region}.amazonaws.com"
    functionName        = "${local.db_identifier}-rotator"
    vpcSubnetIds        = join(",", var.subnet_ids)
    vpcSecurityGroupIds = join(",", var.vpc_security_group_ids)
  }
}

# Enable rotation on application user secret
resource "aws_secretsmanager_secret_rotation" "app_user" {
  count = var.enable_automatic_rotation ? 1 : 0

  secret_id           = aws_secretsmanager_secret.db_secret.id
  rotation_lambda_arn = aws_serverlessapplicationrepository_cloudformation_stack.postgres_rotator[0].outputs.RotationLambdaARN

  rotation_rules {
    automatically_after_days = var.rotation_days
  }
}
```

Add variables:

```hcl
variable "enable_automatic_rotation" {
  description = "Enable automatic password rotation"
  type        = bool
  default     = false
}

variable "rotation_days" {
  description = "Number of days between automatic rotations"
  type        = number
  default     = 30
}
```

Enable in `terraform/environments/prod/main.tf`:

```hcl
module "rds" {
  source = "../../modules/rds"

  # ... existing config ...

  enable_automatic_rotation = true  # Enable rotation
  rotation_days             = 30     # Rotate every 30 days
}
```

### Testing Rotation

Before enabling in production, test in dev:

```bash
# Trigger manual rotation
aws secretsmanager rotate-secret \
  --secret-id demo-app-dev-db-secret \
  --region eu-north-1

# Monitor rotation progress
aws secretsmanager describe-secret \
  --secret-id demo-app-dev-db-secret \
  --region eu-north-1 \
  --query 'RotationEnabled,RotationLambdaARN,LastRotatedDate'

# Check CloudWatch Logs for Lambda execution
aws logs tail /aws/lambda/demo-app-dev-rotator --follow
```

**Successful rotation**:
- Lambda executes without errors
- Application continues working (no connection errors)
- New password in Secrets Manager
- Old password no longer works

**Failed rotation**:
- Check Lambda CloudWatch Logs for errors
- Common issues:
  - Lambda can't reach RDS (VPC/SG configuration)
  - IAM permission issues
  - Database user doesn't exist

---

## Application Integration

### How Applications Handle Rotation

Applications must **fetch credentials on each database connection**, not cache them:

**❌ BAD** - Cached credentials:
```python
# This will break after rotation!
DB_PASSWORD = os.getenv('DB_PASSWORD')  # Loaded once at startup

def connect():
    return psycopg2.connect(
        host=DB_HOST,
        password=DB_PASSWORD  # Stale password after rotation
    )
```

**✅ GOOD** - Fresh credentials:
```python
import boto3
import json

def get_db_credentials():
    """Fetch fresh credentials from Secrets Manager"""
    client = boto3.client('secretsmanager', region_name='eu-north-1')
    response = client.get_secret_value(SecretId=os.getenv('DB_SECRET_ARN'))
    return json.loads(response['SecretString'])

def connect():
    """Connect with fresh credentials"""
    creds = get_db_credentials()
    return psycopg2.connect(
        host=creds['host'],
        port=creds['port'],
        database=creds['dbname'],
        user=creds['username'],
        password=creds['password']
    )
```

**✅ BETTER** - Connection pooling with credential refresh:
```python
from contextlib import contextmanager

class DBConnectionPool:
    def __init__(self):
        self.credentials = None
        self.last_refresh = None
        self.refresh_interval = 3600  # Refresh every hour

    def get_credentials(self):
        now = time.time()
        if not self.credentials or (now - self.last_refresh) > self.refresh_interval:
            client = boto3.client('secretsmanager', region_name='eu-north-1')
            response = client.get_secret_value(SecretId=os.getenv('DB_SECRET_ARN'))
            self.credentials = json.loads(response['SecretString'])
            self.last_refresh = now
        return self.credentials

    @contextmanager
    def get_connection(self):
        creds = self.get_credentials()
        conn = psycopg2.connect(
            host=creds['host'],
            port=creds['port'],
            database=creds['dbname'],
            user=creds['username'],
            password=creds['password']
        )
        try:
            yield conn
        finally:
            conn.close()

# Usage
pool = DBConnectionPool()
with pool.get_connection() as conn:
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM items")
```

### Handling Rotation Events

Applications should gracefully handle credential changes:

```python
def execute_query(query, max_retries=2):
    for attempt in range(max_retries):
        try:
            with pool.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute(query)
                return cursor.fetchall()
        except psycopg2.OperationalError as e:
            if "password authentication failed" in str(e) and attempt < max_retries - 1:
                # Credentials rotated, fetch fresh ones
                pool.credentials = None
                continue
            raise
```

---

## Monitoring Rotation

### CloudWatch Metrics

Monitor rotation success/failure:

```bash
# Check rotation metrics
aws cloudwatch get-metric-statistics \
  --namespace AWS/SecretsManager \
  --metric-name RotationSuccess \
  --dimensions Name=SecretId,Value=demo-app-prod-db-secret \
  --start-time $(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 86400 \
  --statistics Sum \
  --region eu-north-1
```

### CloudWatch Alarms

Create alarm for rotation failures:

```bash
aws cloudwatch put-metric-alarm \
  --alarm-name demo-app-prod-rotation-failure \
  --alarm-description "RDS secret rotation failed" \
  --metric-name RotationSuccess \
  --namespace AWS/SecretsManager \
  --statistic Sum \
  --period 86400 \
  --threshold 1 \
  --comparison-operator LessThanThreshold \
  --evaluation-periods 1 \
  --treat-missing-data notBreaching \
  --dimensions Name=SecretId,Value=demo-app-prod-db-secret \
  --alarm-actions $(terraform output -raw sns_topic_arn) \
  --region eu-north-1
```

### Rotation History

View rotation history:

```bash
# List secret versions
aws secretsmanager list-secret-version-ids \
  --secret-id demo-app-prod-db-secret \
  --region eu-north-1

# Output shows:
# - AWSCURRENT: Currently active password
# - AWSPREVIOUS: Previous password (kept for rollback)
# - AWSPENDING: New password being tested (during rotation)
```

---

## Troubleshooting

### Rotation Failed

**Problem**: Secret rotation fails with Lambda errors

**Diagnosis**:
```bash
# Check rotation status
aws secretsmanager describe-secret \
  --secret-id demo-app-prod-db-secret \
  --region eu-north-1

# Check Lambda logs
aws logs tail /aws/lambda/demo-app-prod-rotator --follow
```

**Common Issues**:

1. **Lambda can't reach RDS**
   - **Cause**: Lambda not in VPC or wrong security group
   - **Fix**: Ensure Lambda is in private subnet with RDS access
   ```bash
   # Check Lambda VPC config
   aws lambda get-function-configuration \
     --function-name demo-app-prod-rotator
   ```

2. **IAM Permission Denied**
   - **Cause**: Lambda role missing permissions
   - **Fix**: Add SecretsManager and RDS permissions to Lambda role

3. **Database User Doesn't Exist**
   - **Cause**: app_user not created in database
   - **Fix**: Create user manually (see Initial Setup section)

### Application Connection Errors After Rotation

**Problem**: Application can't connect to database after rotation

**Diagnosis**:
```bash
# Check application logs
aws logs tail /aws/ec2/demo-app-prod --follow

# Look for: "password authentication failed"
```

**Solutions**:

1. **Application caching old credentials**
   - **Fix**: Implement fresh credential fetching (see Application Integration)

2. **Rotation in progress**
   - **Wait**: Rotation takes 1-2 minutes
   - **Check**: Verify AWSCURRENT version is updated

3. **Secret not updated correctly**
   - **Fix**: Manually verify secret content
   ```bash
   aws secretsmanager get-secret-value \
     --secret-id demo-app-prod-db-secret \
     --region eu-north-1
   ```

### Manual Rollback

If rotation causes issues, rollback to previous password:

```bash
# Get previous version
PREVIOUS_VERSION=$(aws secretsmanager list-secret-version-ids \
  --secret-id demo-app-prod-db-secret \
  --region eu-north-1 \
  --query 'Versions[?VersionStages[0]==`AWSPREVIOUS`].VersionId' \
  --output text)

# Restore previous version as current
aws secretsmanager update-secret-version-stage \
  --secret-id demo-app-prod-db-secret \
  --version-stage AWSCURRENT \
  --remove-from-version-id $(aws secretsmanager describe-secret \
    --secret-id demo-app-prod-db-secret \
    --query 'VersionIdsToStages.keys(@)[0]' \
    --output text) \
  --move-to-version-id $PREVIOUS_VERSION \
  --region eu-north-1
```

---

## Best Practices

### Security

✅ **DO:**
- Rotate credentials at least every 90 days
- Use automatic rotation for production
- Monitor rotation success/failure
- Test rotation in dev before enabling in prod
- Use IAM roles for secret access (not API keys)
- Enable CloudTrail logging for secret access
- Use KMS encryption for secrets

❌ **DON'T:**
- Store passwords in environment variables
- Cache credentials for long periods
- Share master credentials with applications
- Disable rotation without security review
- Use same password across environments

### Application Design

✅ **DO:**
- Fetch credentials dynamically
- Implement connection retry logic
- Use connection pooling with credential refresh
- Handle authentication errors gracefully
- Test application with rotated credentials

❌ **DON'T:**
- Cache credentials at startup
- Hard-code passwords
- Ignore authentication errors
- Skip testing rotation scenarios

### Operations

✅ **DO:**
- Document rotation procedures
- Test rotation in dev quarterly
- Monitor CloudWatch metrics
- Set up rotation failure alarms
- Keep rotation Lambda updated
- Review access logs periodically

❌ **DON'T:**
- Enable rotation without testing
- Ignore rotation failures
- Skip monitoring setup
- Rotate during peak hours (for manual rotation)

---

## Cost Considerations

### Secrets Manager Pricing

| Item | Cost (eu-north-1) | Notes |
|------|-------------------|-------|
| Secret storage | $0.40/month per secret | 2 secrets = $0.80/month |
| API calls | $0.05 per 10,000 calls | First 30,000 free/month |
| Rotation Lambda | ~$0.20/month | Minimal execution time |

**Total cost**: ~$1-2/month for automatic rotation

### Optimization

- Secrets Manager is essential for production security
- Cost is negligible compared to security benefits
- Cache credentials in application to reduce API calls
  - Refresh every 1 hour (not on every DB connection)
  - Still much cheaper than security incident

---

## Summary

**Current Setup**:
- ✅ Secrets created and encrypted
- ✅ IAM-based access from EC2
- ✅ KMS encryption enabled
- ⚠️ Automatic rotation NOT enabled (manual only)

**Recommended Actions**:

**For Production**:
1. Enable automatic rotation (30 days)
2. Set up rotation failure alarms
3. Ensure application fetches fresh credentials
4. Test rotation in dev first
5. Monitor rotation metrics

**For Development**:
- Manual rotation is sufficient
- Rotate when needed (security incidents, personnel changes)
- Use for testing rotation procedures

**Quick Start - Manual Rotation**:
```bash
# See "Manual Password Rotation" section above
# Takes ~5 minutes, requires rolling instance restart
```

**Quick Start - Automatic Rotation**:
```bash
# Use AWS Console → Secrets Manager → Enable Rotation
# Or add Terraform config (see "Automatic Rotation" section)
```

---

**Related Documentation**:
- [RDS Module README](../terraform/modules/rds/README.md)
- [SNS Alerts Setup](./SNS_SETUP.md)
- [Main README](../README.md)

**AWS Documentation**:
- [Secrets Manager Rotation](https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets.html)
- [RDS Password Management](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/rds-secrets-manager.html)
- [Rotation Lambda Functions](https://docs.aws.amazon.com/secretsmanager/latest/userguide/reference_available-rotation-templates.html)
