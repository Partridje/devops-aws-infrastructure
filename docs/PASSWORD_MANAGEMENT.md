# Password Management - AWS Managed Passwords

## Overview

This project uses **AWS RDS Managed Master Password** feature to ensure database passwords **NEVER appear in Terraform state files**. This is a security best practice that meets compliance requirements for SOC2, PCI-DSS, and HIPAA.

## Implementation Changes

### What Was Changed

**1. RDS Module** (`terraform/modules/rds/main.tf`)
- ✅ Removed `random_password` resource
- ✅ Added `manage_master_user_password = true` to RDS instance
- ✅ Added `master_user_secret_kms_key_id` for KMS encryption
- ✅ Created additional secret with connection details
- ✅ Updated lifecycle rules

**2. Outputs** (`terraform/modules/rds/outputs.tf`)
- ✅ Added `master_user_secret_arn` output (AWS-managed secret)
- ✅ Added `db_connection_secret_arn` output (connection details)
- ✅ Marked all sensitive outputs with `sensitive = true`
- ✅ Maintained backward compatibility with legacy output names

**3. EC2 User Data** (`terraform/modules/ec2/user_data.sh`)
- ✅ Updated to retrieve password from AWS-managed secret
- ✅ Two-step retrieval: connection details + password
- ✅ Added comprehensive logging

### Security Impact

| Aspect | Before | After |
|--------|--------|-------|
| State file exposure | ❌ Password in plaintext | ✅ Only ARN reference |
| Terraform logs | ❌ Password visible | ✅ Marked sensitive |
| Password rotation | Manual only | ✅ Automatic supported |
| Audit trail | Limited | ✅ CloudTrail logs all access |
| Compliance | ⚠️ Violations | ✅ SOC2/PCI/HIPAA ready |

## How It Works

### Traditional Approach (INSECURE)

```hcl
# ❌ OLD WAY - Password stored in Terraform state
resource "random_password" "db_password" {
  length = 32
}

resource "aws_db_instance" "main" {
  password = random_password.db_password.result  # Stored in state!
}
```

**Problems:**
- Password stored in `terraform.tfstate` in plaintext
- Anyone with access to state file can see password
- State file in S3 is a security risk point
- Difficult to rotate passwords
- Compliance issues

### AWS Managed Password Approach (SECURE)

```hcl
# ✅ NEW WAY - Password never in Terraform state
resource "aws_db_instance" "main" {
  manage_master_user_password   = true  # AWS generates password
  master_user_secret_kms_key_id = aws_kms_key.rds[0].arn
}
```

**Benefits:**
- ✅ Password generated by AWS, never visible to Terraform
- ✅ Password stored in AWS Secrets Manager, encrypted with KMS
- ✅ Password NEVER appears in `terraform.tfstate`
- ✅ Supports automatic rotation
- ✅ All access logged in CloudTrail
- ✅ Meets compliance requirements

## Secret Architecture

The module creates **two secrets** in AWS Secrets Manager:

### 1. AWS-Managed Password Secret

**Name**: `rds!cluster-{random-id}`
**Managed by**: AWS RDS Service
**Contains**: Only the master password

```json
{
  "password": "generated-by-aws-32-character-secure-password"
}
```

**Key Properties:**
- Created automatically by RDS
- Password never exposed to Terraform
- Can be rotated by AWS
- Encrypted with KMS
- Accessible via IAM policies

### 2. Connection Details Secret

**Name**: `{name_prefix}-{environment}-db-connection-{random}`
**Managed by**: Terraform
**Contains**: All connection details except password

```json
{
  "username": "dbadmin",
  "host": "myapp-dev-db.abc123.eu-north-1.rds.amazonaws.com",
  "port": 5432,
  "dbname": "appdb",
  "engine": "postgres",
  "masterUserSecretArn": "arn:aws:secretsmanager:eu-north-1:123456789:secret:rds!...",
  "passwordRetrievalCommand": "aws secretsmanager get-secret-value --secret-id ..."
}
```

**Key Properties:**
- Contains connection metadata
- References AWS-managed password secret ARN
- Safe to store in Terraform state (no password)
- Useful for applications that need full connection info

## Retrieving Passwords

### From Command Line

```bash
# Get connection details secret ARN
terraform output -raw db_connection_secret_arn

# Get AWS-managed password secret ARN
terraform output -raw master_user_secret_arn

# Retrieve the password
aws secretsmanager get-secret-value \
  --secret-id $(terraform output -raw master_user_secret_arn) \
  --query SecretString --output text | jq -r .password
```

### From Application (Python)

```python
import boto3
import json

def get_db_connection():
    """Get database connection details with AWS-managed password"""
    client = boto3.client('secretsmanager')

    # Get connection details
    conn_secret_arn = os.environ['DB_CONNECTION_SECRET_ARN']
    conn_response = client.get_secret_value(SecretId=conn_secret_arn)
    conn_details = json.loads(conn_response['SecretString'])

    # Get password from AWS-managed secret
    master_secret_arn = conn_details['masterUserSecretArn']
    pwd_response = client.get_secret_value(SecretId=master_secret_arn)
    pwd_data = json.loads(pwd_response['SecretString'])

    return {
        'host': conn_details['host'],
        'port': conn_details['port'],
        'database': conn_details['dbname'],
        'username': conn_details['username'],
        'password': pwd_data['password']
    }

# Usage
creds = get_db_connection()
connection_string = f"postgresql://{creds['username']}:{creds['password']}@{creds['host']}:{creds['port']}/{creds['database']}"
```

### From EC2 User Data (Auto-configured)

The `user_data.sh` script automatically retrieves credentials:

```bash
# Automatically executed on EC2 startup
export DB_HOST=$(echo $DB_CONNECTION | jq -r '.host')
export DB_USER=$(echo $DB_CONNECTION | jq -r '.username')
export DB_PASSWORD=$(echo $DB_PASSWORD_SECRET | jq -r '.password')
```

## Security Features

### 1. Ephemeral Values

Password never stored in:
- ❌ Terraform state files
- ❌ Terraform plan outputs
- ❌ Terraform logs
- ❌ Version control
- ❌ CI/CD logs

### 2. Encryption at Rest

- Password encrypted with KMS in Secrets Manager
- KMS key supports automatic rotation
- Separate KMS keys per environment (dev/prod)

### 3. Encryption in Transit

- Secrets Manager uses TLS/HTTPS
- Database connections use SSL/TLS
- No cleartext password transmission

### 4. Access Control

```hcl
# Example IAM policy for application
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "secretsmanager:GetSecretValue",
      "Resource": [
        "arn:aws:secretsmanager:*:*:secret:rds!*",
        "arn:aws:secretsmanager:*:*:secret:*-db-connection-*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": "kms:Decrypt",
      "Resource": "arn:aws:kms:*:*:key/*"
    }
  ]
}
```

### 5. Audit Trail

All password access logged in CloudTrail:
- Who accessed the password
- When it was accessed
- From which resource
- Success or failure

## Password Rotation

### Manual Rotation

```bash
# Rotate password manually via AWS Console or CLI
aws rds modify-db-instance \
  --db-instance-identifier myapp-dev-db \
  --master-user-password "$(openssl rand -base64 32)" \
  --apply-immediately
```

### Automatic Rotation (Optional)

Enable automatic rotation in Secrets Manager:

```bash
aws secretsmanager rotate-secret \
  --secret-id $(terraform output -raw master_user_secret_arn) \
  --rotation-lambda-arn arn:aws:lambda:eu-north-1:123456789:function:SecretsManagerRDSPostgreSQLRotation \
  --rotation-rules AutomaticallyAfterDays=30
```

## Compliance Benefits

### SOC 2

- ✅ Type 1 & 2 compliant password management
- ✅ Audit logs for all access
- ✅ Encryption at rest and in transit

### PCI-DSS

- ✅ Requirement 8.2.3: Passwords not stored in plaintext
- ✅ Requirement 8.2.4: Passwords encrypted
- ✅ Requirement 10: Audit trail

### HIPAA

- ✅ Technical safeguards (§164.312)
- ✅ Encryption requirements
- ✅ Access control mechanisms

## Migration from Old Approach

If you have existing RDS instances using `random_password`:

1. **Backup database**
2. **Take snapshot** of RDS instance
3. **Update Terraform code** to use `manage_master_user_password = true`
4. **Apply changes** with `terraform apply`
5. **Update application** to retrieve password from new secret location
6. **Test connection**
7. **Remove old secret** from Secrets Manager

## Troubleshooting

### Error: "master_user_secret not available"

```bash
# Check RDS instance status
aws rds describe-db-instances \
  --db-instance-identifier myapp-dev-db \
  --query 'DBInstances[0].MasterUserSecret'
```

### Error: "Access Denied to Secrets Manager"

Ensure IAM role has permissions:
```json
{
  "Effect": "Allow",
  "Action": "secretsmanager:GetSecretValue",
  "Resource": "arn:aws:secretsmanager:*:*:secret:rds!*"
}
```

### Error: "Cannot decrypt secret"

Ensure IAM role has KMS permissions:
```json
{
  "Effect": "Allow",
  "Action": "kms:Decrypt",
  "Resource": "arn:aws:kms:*:*:key/*"
}
```

## Best Practices

1. ✅ **Never log passwords** - Use sensitive outputs in Terraform
2. ✅ **Rotate regularly** - Enable automatic rotation
3. ✅ **Least privilege** - Grant minimal IAM permissions
4. ✅ **Monitor access** - Set up CloudWatch alarms for unusual access
5. ✅ **Use SSL** - Always connect to database with SSL/TLS
6. ✅ **Separate environments** - Different secrets for dev/prod
7. ✅ **Backup secrets** - Enable versioning in Secrets Manager

## References

- [AWS RDS Managed Master Password](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/rds-secrets-manager.html)
- [Terraform ephemeral values](https://developer.hashicorp.com/terraform/language/values/ephemeral)
- [AWS Secrets Manager Best Practices](https://docs.aws.amazon.com/secretsmanager/latest/userguide/best-practices.html)
- [Compliance Standards](https://aws.amazon.com/compliance/)
